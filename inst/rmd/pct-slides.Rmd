---
title: "The Propensity to Cycle Tool"
subtitle: '`r emojifont::emoji("bike")`<br/>For England and Wales'
# subtitle: '`r emojifont::emoji("bike")`<br/>Advanced Training Workshop'
author: "Robin Lovelace and Joey Talbot, ITS, University of Leeds"
date: 'Public Health + Sustainable Transport Summit 2020<br/><img class="img-footer" alt="" src="https://www.pct.bike/www/static/01_logos/pct-logo.png"><br/><img class="img-footer" alt="" src="https://www.stephanehess.me.uk/images/picture3.png">'
output:
  xaringan::moon_reader:
    # css: ["default", "its.css"]
    # chakra: libs/remark-latest.min.js
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
# bibliography:
#  - ../vignettes/ref.bib
#  - ../vignettes/ref_training.bib
---

```{r setup, include=FALSE, eval=TRUE}
# get citations
refs = RefManageR::ReadZotero(group = "418217", .params = list(collection = "JFR868KJ", limit = 100))
refs_df = as.data.frame(refs)
# View(refs_df)
# citr::insert_citation(bib_file = "vignettes/refs_training.bib")
RefManageR::WriteBib(refs, "refs.bib")
# citr::tidy_bib_file(rmd_file = "vignettes/pct_training.Rmd", messy_bibliography = "vignettes/refs_training.bib")
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(message = FALSE)
library(RefManageR)
BibOptions(check.entries = FALSE, 
           bib.style = "authoryear", 
           cite.style = 'alphabetic', 
           style = "markdown",
           first.inits = FALSE,
           hyperlink = FALSE, 
           dashed = FALSE)
my_bib = refs
```

```{r, include=FALSE}
library(RefManageR)
my_bib = RefManageR::ReadBib("refs.bib")
```


background-image: url(https://media.giphy.com/media/YlQQYUIEAZ76o/giphy.gif)
background-size: cover
class: center, middle

# How the PCT works

---

## The first prototype of the PCT

- 1st prototype: Hackathon at ODI Leeds in February 2015

- We identifying key routes and mapped them

- For description of aims, see Lovelace et al. (2017)

```{r, echo=FALSE}
knitr::include_graphics("https://raw.githubusercontent.com/npct/pct-team/master/figures/early.png")
```

---

## The PCT in 2020

- Now the go-to tool for strategic cycle network planning in England and Wales, used by most local authorities with cycling plans ([source](https://npct.github.io/pct-shiny/regions_www/www/static/03d_other_reports/2019-use-of-pct-report.pdf)).

.pull-left[

## Geographic levels in the PCT


- Generate and analyse route networks for transport planning with reference to:
    - Zones
    - Origin-destination (OD) data
    - Geographic desire lines
    - Route allocation using different routing services
    - Route network generation and analysis
]

.pull-right[

![](https://user-images.githubusercontent.com/1825120/94201205-9758c600-feb3-11ea-8383-a01966457562.png)
See these levels at [www.pct.bike](https://www.pct.bike)

]

---

## Let's look at zones

![](https://user-images.githubusercontent.com/1825120/94204655-89a63f00-feb9-11ea-8b6d-89910008e830.png)
```{r, eval=FALSE, echo=FALSE}
qtm(od_data_zones_min)
```

---

## MSOA vs LSOA zones (MSOA zones ~4 times bigger)

```{r, echo=FALSE}
knitr::include_graphics("https://user-images.githubusercontent.com/1825120/96573136-a1f55800-12c5-11eb-8921-c9938cd9e929.gif")
```


---

## OD data

```{r, echo=FALSE, message=FALSE}
library(tmap)
library(od)
tmap_mode("plot")
od_test = od::od_data_df
od_test$id = 1:nrow(od_test)
od_test$perc_cycle = round(od_test$bicycle / od_test$all, 3) * 100
knitr::kable(od_test, caption = "Origin-destination data. Open MSOA-MSOA commute data from the 2011 census, accessed using the R package pct.")
```

---

## Desire lines

```{r, echo=FALSE, message=FALSE}
l = od_to_sf(od_test, od_data_centroids)
l = dplyr::select(l, id, foot, bicycle, car_driver, perc_cycle)
p = od_data_centroids
p = p[l, ]
tm_shape(l) +
  tm_lines("perc_cycle", palette = "viridis", lwd = "car_driver", legend.lwd.show = FALSE, scale = 9, alpha = 0.5) +
  tm_text("id") +
  tm_shape(p) +
  tm_text("geo_code")
```

---

## Routes

```{r, echo=FALSE, eval=FALSE}
library(cyclestreets)
r = stplanr::route(l = l, route_fun = journey)
saveRDS(r, "routes_od_data_df_df.Rds")
piggyback::pb_upload("routes_od_data_df_df.Rds")
piggyback::pb_download_url("routes_od_data_df_df.Rds")
file.remove("routes_od_data_df_df.Rds")
```


```{r, eval=FALSE, echo=FALSE}
tm_shape(r) +
  tm_lines("perc_cycle", palette = "viridis", lwd = "car_driver", legend.lwd.show = FALSE, scale = 9, alpha = 0.5) +
  tm_shape(p) +
  tm_text("geo_code")
```

![](https://user-images.githubusercontent.com/1825120/94204162-a8f09c80-feb8-11ea-9b88-cce88001ff01.png)
---

### Route networks

```{r, echo=FALSE}
u = "https://github.com/ITSLeeds/pct/releases/download/0.5.0/routes_od_data_df_df.Rds"
f = basename(u)
if(!file.exists(f)){
  download.file(u, f)
}
r = readRDS(f)
```


```{r, message=FALSE}
rnet = stplanr::overline(r, "bicycle")
plot(rnet, lwd = rnet$bicycle / 10)
```

---

### Cycling uptake

![](https://itsleeds.github.io/pct/reference/uptake_pct_govtarget-1.png)

--

Dose/response modelling: about cycling in response to distance, hilliness and other factors. Source: [pct R package website](https://itsleeds.github.io/pct/reference/uptake_pct_govtarget.html)

---

background-image: url(https://user-images.githubusercontent.com/1825120/72727608-443fae00-3b83-11ea-9dc1-90c50efac927.png)

# Live demo of the PCT

## See https://www.pct.bike/


---

background-image: url(https://media.giphy.com/media/YlQQYUIEAZ76o/giphy.gif)

---


.pull-left[

# Uses of the PCT

- Visioning
- Planning strategic cycle networks
- Identifying corridors with high latent demand

Uses that were not initially planned

- Pop-up cycleway planning
- LTN planning?

]

--

.pull-right[

## What it cannot do

- Junction design
- *Exact* route plan (PCT results are based on 'fastest route')
- Public-transport integration 
- Other trip purposes beyond single stage journeys cycling to work and school
- Planning for future developments 

]

---

## The Rapid tool

- Live demo by Joey Talbot

---

# The PCT Advanced Workshop

## 12th November

## Sign-up: watch this space... (BaseCamp, Landor)

---

## The team

### Robin Lovelace

- Geographer by Training
- Associate Professor in Transport Data Science, Institute for Transport Studies, University of Leeds
- Lead Developer of the Propensity to Cycle Tool
- R developer and teacher, author of open source books *Efficient R Programming* and *Gecomputation with R*

--

### Joey Talbot

- Experienced data scientist
- Policy and planning knowledge through role in Transport for New Homes

### Rosa Felix

- Civil Engineer by training
- Working on cycling potential and infrastructure prioritisation

--

### How about you?

---

## Overview of workshop

<!-- - The venue + facilities -->
- Seminar: how the Propensity to Cycle Tool works (45 min)

--
   
   â˜•â˜•â˜• 15 minute break  â˜•â˜•â˜•

--

- Workshop part 1: getting started with transport data in R (45 min)

   â˜•â˜•â˜• 15 minute break  â˜•â˜•â˜•

--

- Workshop part 2: using PCT data for local transport planning (1 hr)

  ðŸ»ðŸ»ðŸ» 


```{r, echo=FALSE, eval=FALSE}
library(leaflet)
l = stplanr::geo_code("Institute for Transport Studies, University of Leeds")
leaflet() %>% 
  addProviderTiles(provider = providers$OpenStreetMap.BlackAndWhite) %>%
  addMarkers(lng = l[1], lat = l[2])
```

---

## Learning outcomes


- Understand the data and code underlying the PCT
- Download data from the PCT at various geographic levels
- Use R as a tool for data analysis to support evidence-based planning

--

It's about free and open source software for a sustainable future `r emojifont::emoji("rocket")`
![](https://media.giphy.com/media/fnvxO81StvLdhd0Tlu/giphy.gif)

# Coding

```{r, eval=FALSE}
od_test$perc_cycle = round(od_test$bicycle / od_test$all) * 100
l = od_to_sf(od_test, od_data_centroids)
r = stplanr::route(l = l, route_fun = journey)
rnet = overline(r, "bicycle")
```

--

![](https://media.giphy.com/media/3oKIPnAiaMCws8nOsE/giphy.gif)

---

## Key stages of PCT approach

- Reproducible, open, scripted, enabling modifications, e.g.:
- Find short routes in which more people drive than cycle

--

- Stage 1: get data

```{r, eval=FALSE, echo=FALSE}
# Aim: get top 1000 lines in repo
library(dplyr)
library(sf)
desire_lines_all = pct::get_pct_lines(region = "isle-of-wight")
desire_lines = desire_lines_all %>% 
  top_n(1000, all)
write_sf(desire_lines, "desire_lines.geojson")
piggyback::pb_upload("desire_lines.geojson")
```


```{r, message=FALSE}
# Set-up, after installing pct and checking out www.pct.bike:
library(dplyr)
library(sf)
desire_lines_all = pct::get_pct_lines(region = "isle-of-wight") %>% 
  top_n(n = 1000, wt = all)
```

---

## Stage II: Subset data of interest

- Interested only in major lines

```{r}
library(sf)
desire_lines = desire_lines_all %>% 
  filter(all > 50) %>% 
  select(geo_code1, geo_code2, all, bicycle, foot, car_driver, rf_dist_km)
plot(desire_lines)
```

---

## Stage III: Visualisation

<!-- A fundamental part of data science is being able to understand your data. -->

<!-- That requires visualisation, R is great for that: -->

```{r, warning=FALSE, eval=FALSE, echo=FALSE}
.pull-left[
plot(desire_lines)
]
.pull-right[
]
```

<!-- - Interactively: -->

```{r, message=FALSE}
library(tmap)
tmap_mode("view")
tm_shape(desire_lines) +
  tm_lines("all", scale = 9) +
  tm_basemap(server = leaflet::providers$OpenStreetMap)
```

---

## Stage IV: Origin-destination data analysis

- Now we have data in our computer, and verified it works, we can use it

- Which places are most car dependent? 

```{r}
car_dependent_routes = desire_lines %>% 
  mutate(percent_drive = car_driver / all * 100) %>% 
  filter(rf_dist_km < 3 & rf_dist_km > 1) 
```

- Get routes

```{r, eval=FALSE}
routes = stplanr::line2route(car_dependent_routes)
car_dependent_routes$geometry = routes$geometry
```

<!-- -- -->

<!-- - Any questions? -->

<!-- -- -->

<!-- - Everyone happy with RStudio? -->

<!-- --- -->

<!-- # Supporting reference materials -->

<!-- All interactive programming/analysis with command line interface involves frequent reference to documentation, and data science is no exception. Places to look for help (in roughly descending order): -->

<!-- -- -->

<!-- - Your colleague -->
<!-- - R's internal help (e.g. with `?functonname` or `vignettes(package = "packagename)`) -->
<!-- - Online documentation, e.g. for the pct package: https://itsleeds.github.io/pct/  -->
<!-- - *Transport and Geographic Data Science with R*: An introduction to R aimed at transport planners: https://git.io/tds2dayex -->

<!-- - The transport chapter ([12](https://geocompr.robinlovelace.net/transport.html)) in the open source book [*Geocomputation with R*](https://geocompr.robinlovelace.net/) -->
<!-- - R for Data Science -->

<!-- --- -->

<!-- # Exercises -->

<!-- - If you're happy with R, work through G1 to G8 in the [exercises](https://itsleeds.github.io/pct/articles/pct_training.html#exercises), starting: -->
<!--     - G1: Using the PCT's online interface, hosted at [www.pct.bike/m/?r=isle-of-wight](https://www.pct.bike/m/?r=isle-of-wight), identify the MSOA **zone** that has the highest number of people who cycle to work. -->

<!-- - If you're just getting started with RStudio: Work through Section 1 of https://git.io/tds2dayex -->

<!-- - Getting up to speed with data manipulation in the tidyverse: Work through and reproduce the code in Section [5.2](https://r4ds.had.co.nz/transform.html#filter-rows-with-filter) of R for Data Science. -->

<!-- --- -->

<!-- # The PCT hackathon -->

<!-- -- -->

<!-- Overall aim: generate ideas related to and extending the PCT -->

<!-- -- -->

<!-- Ideas: -->

<!-- - Create a route network reflecting where you would invest if the priority was reducing car trips of less than 5 km -->

<!-- -- -->

<!-- - Design interventions to replace short car trips across West Yorkshire (or another region of your choice) using the PCT methods/data to support your decisions -->

<!-- -- -->

<!-- - Identify quiet routes and design a quiet route network for city/region of your choice, e.g. Leeds -->

<!-- -- -->

<!-- - Import alternative origin-destination datasets and use those as the basis for propensity to cycle analysis for trip purposes other than single stage commutes, encapsulated in the commut layer in the PCT -->
<!-- - Any other layers/scenarios/hacks: welcome! Comments in this repo's [issue tracker](https://github.com/ITSLeeds/pct/issues) also welcome. -->



---

# Other topics

---

## Transport software - which do you use?

```{r, echo=FALSE, message=FALSE, warning=FALSE}
u = "https://github.com/ITSLeeds/TDS/raw/master/transport-software.csv"
tms = readr::read_csv(u)[1:5]
tms = dplyr::arrange(tms, dplyr::desc(Citations))
knitr::kable(tms, booktabs = TRUE, caption = "Sample of transport modelling software in use by practitioners. Note: citation counts based on searches for company/developer name, the product name and 'transport'. Data source: Google Scholar searches, October 2018.", format = "html")
```

---

## Data science and the tidyverse

- Inspired by Introduction to data science with R (available free [online](https://r4ds.had.co.nz/)) `r Citep(my_bib, "grolemund_r_2016", .opts = list(cite.style = "authoryear"))`


```{r tds-cover, echo=FALSE, out.width="30%"}
knitr::include_graphics("https://d33wubrfki0l68.cloudfront.net/b88ef926a004b0fce72b2526b0b5c4413666a4cb/24a30/cover.png")
```

---

## A geographic perspective

- See https://github.com/ITSLeeds/TDS/blob/master/catalogue.md

- Paper on the **stplanr** paper for transport planning (available [online](https://cran.r-project.org/web/packages/stplanr/vignettes/stplanr-paper.html)) `r Citep(my_bib, "lovelace_stplanr:_2018", .opts = list(cite.style = "authoryear"))`
- Introductory and advanced content on geographic data in R, especially the [transport chapter](https://geocompr.robinlovelace.net/transport.html) (available free [online](https://geocompr.robinlovelace.net/)) `r Citep(my_bib, "lovelace_geocomputation_2019", .opts = list(cite.style = "authoryear"))` 
- Paper on analysing OSM data in Python `r Citep(my_bib, "boeing_osmnx_2017", .opts = list(cite.style = "authoryear"))` (available [online](https://arxiv.org/pdf/1611.01890)) 

---

# Getting support

--

With open source software, the world is your support network!

--

- Recent example: https://stackoverflow.com/questions/57235601/

--

- [gis.stackexchange.com](https://gis.stackexchange.com/questions) has 21,314 questions 

- [r-sig-geo](https://r-sig-geo.2731867.n2.nabble.com/) has 1000s of posts

- RStudio's Discourse community has 65,000+ posts already!

--

- No transport equivalent (e.g. earthscience.stackexchange.com is in beta)

- Potential for a Discourse forum or similar: transport is not (just) GIS


# Summary

Title: Propensity to Cycle Tool Advanced Training Workshop

Presenters: Dr Robin Lovelace and Dr Joey Talbot (University of Leeds)

This workshop will provide an overview of the PCT for advanced users, including:

- transport planners with experience of evidence-based prioritisation
- researchers with experience of using origin-destination, route and route network level data
- programmers, developers and others wanting to extend PCT methods for the public benefit

The workshop will be broken into three main parts:

- A 45 min talk plus demo of the tool and time for questions (which will be recorded for future use)
- A 45 minute tutorial in which I will demonstrate how the PCT works and how to extend analysis provided at www.pct.bike using R (requires R and RStudio to be installed and experience using command line computing tools)
- A 1 hour session where participants will use data from the PCT to tackle real-world problems in their local area

The Hopin platform will be used, enabling break-out sessions.

---

# Description: 

In this workshop you will take a deep dive into the Propensity to Cycle Tool (PCT).
Beginner and intermediate PCT events focus on using the PCT via the web application hosted at www.pct.bike and the data provided by the PCT in QGIS but the focus here is on analysing cycling potential in the open source statistical programming language R. The majority of the PCT was built on R, which is a powerful object-orientated programming language with a focus on statistical modelling, visualisation and geographic analysis. The workshop will show how the code underlying the PCT works, how the underlying data can be accessed for reproducible analysis, and how the methods can be used to generate new scenarios of cycling uptake.

If you are inexperienced with R you should prepare by taking a free online course such as that provided by DataCamp or by working through Chapter 2 onwards of the open source book Geocomputation with R (see reading list below for more transport-specific resources) before signing-up.

---

# Agenda and sign-up

- 14:00 - 14:45 Talk on the PCT and questions
  - 14:45 - 15:00 Virtual networking and break
- 15:00 - 15:45 Propensity to Cycle Tool worked tutorial in R
  - 15:45 - 16:00 Networking, questions and break
- 16:00 - 17:00 Application of methods to study areas

To sign-up, please ensure that you have the right set-up.
See [here](https://docs.ropensci.org/stats19/articles/stats19-training-setup.html) for a guide on installing R and RStudio for transport data research.
To get the access code for the tutorial, you will need to first work through the code shown here:
https://github.com/ITSLeeds/pct/blob/master/inst/test-setup.R
After you have run the code, running the following line should give you a number that will give you the access code for the course:

```r
round(mean(rnet_potential$Potential))
```

Save that 3 digit number, it will allow access to the workshop.
If you have any issues with your computer set-up, please ask a question here (you will need to sign-up for a GitHub account if you have not already done so): https://github.com/ITSLeeds/pct/issues/67 

<!-- 215.1371 -->

<!-- - 09:30 - 10:00: Arrival and set-up -->
<!-- - 10:00 - 11:00: Data and methods underlying the PCT -->
<!-- - 11:00 - 12:30: Getting and analysing PCT data -->
<!--     - Comparing PCT results with existing road infrastructure -->
<!--         - Getting data from the CyIPT -->
<!--         - Identfying 'weak links' -->
<!--         - Identify gaps in the network -->

<!-- Lunch break -->

<!-- - 13:30 - 15:30: Extending the PCT: minihack -->
<!--     - Alternative scenarios of cycling uptake -->
<!--         - A 'replace short car trips' scenario -->
<!--     - New input data -->
<!--         - Travel to stations -->
<!--     - Other extensions of the PCT -->

<!-- Break and presentation of results -->

<!-- - 16:00 - 16:30: Policy implementation -->


---

# References

```{r, 'refs', results="asis", echo=FALSE}
PrintBibliography(my_bib)
# RefManageR::WriteBib(my_bib, "refs-geostat.bib")
```

<!-- --- -->

<!-- ## Transport planning software -->

<!-- Transport modelling software products are a vital component of modern transport planning *and* research. -->

<!-- - They generate the evidence base on which strategic investments are made and, furthermore, -->
<!-- - provide a powerful mechanism for researching alternative futures. -->

<!-- -- -->

<!-- It would not be an overstatement to say that software determines the range of futures that are visible to policymakers. This makes status of transport modelling software and how it may evolve in the future important questions. -->

<!-- What will transport software look like? What will their capabilities be? And who will control? Answers to each of these questions will affect the future of transport systems.  -->

<!-- -- -->

<!-- - Premise: transport planning/modelling software used in practice ~~will become~~ is becoming increasingly data-driven, modular and open.  -->



<!-- --- -->

<!-- ```{r geocompr-cover, echo=FALSE, out.width="20%"} -->
<!-- knitr::include_graphics("https://geocompr.robinlovelace.net/images/cover.png") -->
<!-- ``` -->
